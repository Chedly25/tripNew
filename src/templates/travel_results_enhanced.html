<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Perfect European Road Trip</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="icon" type="image/svg+xml" href="/static/logo.svg">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/logo.svg">
    <link rel="icon" type="image/svg+xml" sizes="32x32" href="/static/logo.svg">
    <link rel="icon" type="image/svg+xml" sizes="16x16" href="/static/logo.svg">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome with multiple CDN fallbacks -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" 
          integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" 
          crossorigin="anonymous">
    <script>
        // FontAwesome fallback loader
        if (!window.FontAwesome) {
            document.write('<link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.4.0/css/all.css">');
        }
    </script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Leaflet for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Fallback CSS for icons and fonts -->
    <link rel="stylesheet" href="/static/fallback.css">
    
    <style>
        :root {
            --primary: #6366f1;
            --primary-light: #818cf8;
            --primary-dark: #4f46e5;
            --secondary: #06b6d4;
            --accent: #f59e0b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #0f172a;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --gray-900: #0f172a;
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.3);
            --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: var(--gradient);
            min-height: 100vh;
            color: var(--gray-800);
            overflow-x: hidden;
        }
        
        /* Animated background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="40" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="40" cy="80" r="1.5" fill="rgba(255,255,255,0.1)"/><circle cx="90" cy="90" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="10" cy="60" r="1" fill="rgba(255,255,255,0.1)"/></svg>') repeat;
            animation: float 20s linear infinite;
            pointer-events: none;
            z-index: -1;
        }
        
        @keyframes float {
            0% { transform: translateY(0px) rotate(0deg); }
            100% { transform: translateY(-100px) rotate(360deg); }
        }
        
        .hero-header {
            background: transparent;
            color: white;
            padding: 3rem 0 2rem;
            text-align: center;
            position: relative;
        }
        
        .hero-title {
            font-family: 'Playfair Display', Georgia, 'Times New Roman', serif;
            font-size: clamp(2rem, 4vw, 3rem);
            font-weight: 700;
            margin-bottom: 1rem;
            text-shadow: 0 4px 20px rgba(0,0,0,0.3);
            letter-spacing: -0.02em;
        }
        
        .hero-subtitle {
            font-size: clamp(1rem, 2vw, 1.2rem);
            opacity: 0.95;
            font-weight: 400;
            line-height: 1.6;
        }
        
        .itinerary-card {
            background: var(--glass-bg);
            border-radius: 32px;
            padding: 2.5rem;
            margin-bottom: 2.5rem;
            box-shadow: 
                0 32px 64px rgba(0,0,0,0.1),
                0 0 0 1px rgba(255,255,255,0.2);
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(20px);
            transition: all 0.3s ease;
        }
        
        .itinerary-card:hover {
            transform: translateY(-8px);
            box-shadow: 
                0 40px 80px rgba(0,0,0,0.15),
                0 0 0 1px rgba(255,255,255,0.3);
            background: rgba(255, 255, 255, 0.8);
        }
        
        .itinerary-header {
            display: flex;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .itinerary-icon {
            width: 72px;
            height: 72px;
            border-radius: 24px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.75rem;
            margin-right: 1.5rem;
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3);
            transition: all 0.3s ease;
        }
        
        .itinerary-card:hover .itinerary-icon {
            transform: scale(1.05) rotate(5deg);
            box-shadow: 0 12px 32px rgba(99, 102, 241, 0.4);
        }
        
        .itinerary-title {
            font-family: 'Playfair Display', Georgia, 'Times New Roman', serif;
            font-size: 1.9rem;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }
        
        .itinerary-subtitle {
            color: var(--gray-600);
            font-size: 1rem;
            line-height: 1.5;
            font-weight: 400;
        }
        
        .route-stats {
            display: flex;
            gap: 2rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: rgba(255, 255, 255, 0.5);
            padding: 1rem 1.25rem;
            border-radius: 16px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.2s ease;
        }
        
        .stat-item:hover {
            background: rgba(255, 255, 255, 0.7);
            transform: translateY(-2px);
        }
        
        .stat-icon {
            width: 44px;
            height: 44px;
            border-radius: 14px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        
        .stat-text {
            color: var(--gray-800);
            font-weight: 600;
            font-size: 0.95rem;
        }
        
        .route-map {
            height: 350px;
            border-radius: 20px;
            margin-bottom: 2rem;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
        }
        
        .cities-list {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        
        .city-badge {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
            transition: all 0.2s ease;
        }
        
        .city-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4);
        }
        
        .highlights-section {
            background: rgba(255, 255, 255, 0.4);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .highlights-title {
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.1rem;
        }
        
        .highlight-item {
            background: rgba(255, 255, 255, 0.7);
            padding: 1rem 1.25rem;
            border-radius: 14px;
            margin-bottom: 0.75rem;
            border-left: 4px solid var(--primary);
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--gray-700);
            transition: all 0.2s ease;
        }
        
        .highlight-item:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: translateX(4px);
        }
        
        .cost-estimate {
            background: rgba(240, 249, 255, 0.8);
            border-radius: 20px;
            padding: 2rem;
            border: 2px solid rgba(186, 230, 253, 0.6);
            backdrop-filter: blur(10px);
        }
        
        .cost-title {
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.1rem;
        }
        
        .cost-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 1.25rem;
        }
        
        .cost-item {
            text-align: center;
            background: rgba(255, 255, 255, 0.8);
            padding: 1.5rem 1rem;
            border-radius: 16px;
            border: 1px solid rgba(224, 242, 254, 0.8);
            transition: all 0.2s ease;
        }
        
        .cost-item:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .cost-amount {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.25rem;
        }
        
        .cost-label {
            font-size: 0.9rem;
            color: var(--gray-600);
            font-weight: 500;
        }
        
        .select-route-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border: none;
            color: white;
            padding: 1.25rem 2.5rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 1.1rem;
            width: 100%;
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .select-route-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .select-route-btn:hover::before {
            left: 100%;
        }
        
        .select-route-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 20px 40px rgba(99, 102, 241, 0.3);
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
        }
        
        .route-actions {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .route-action-buttons {
            display: flex;
            justify-content: center;
            gap: 0.75rem;
        }
        
        .action-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .save-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        
        .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.3);
        }
        
        .save-btn.saved {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .share-btn {
            background: linear-gradient(135deg, #06b6d4, #0891b2);
            color: white;
        }
        
        .share-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(6, 182, 212, 0.3);
        }
        
        .weather-btn {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }
        
        .weather-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(245, 158, 11, 0.3);
        }
        
        .back-btn {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(255, 255, 255, 0.5);
            color: var(--gray-800);
            padding: 1rem 1.75rem;
            border-radius: 20px;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            transition: all 0.2s ease;
            margin-bottom: 2.5rem;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .back-btn:hover {
            background: white;
            color: var(--primary);
            text-decoration: none;
            transform: translateY(-2px);
            border-color: var(--primary);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.2);
        }
        
        @media (max-width: 768px) {
            .hero-title {
                font-size: 2rem;
            }
            
            .itinerary-card {
                padding: 1.5rem;
            }
            
            .route-stats {
                gap: 1rem;
            }
            
            .cities-list {
                gap: 0.5rem;
            }
            
            .city-badge {
                font-size: 0.8rem;
                padding: 0.4rem 0.8rem;
            }
        }
        
        .leaflet-container {
            border-radius: 12px;
        }
        
        .route-type-scenic { --route-color: #10b981; }
        .route-type-cultural { --route-color: #8b5cf6; }
        .route-type-adventure { --route-color: #f59e0b; }
        .route-type-culinary { --route-color: #ef4444; }
        .route-type-romantic { --route-color: #ec4899; }
        .route-type-hidden_gems { --route-color: #6366f1; }
        
        .itinerary-card[data-route-type="scenic"] .itinerary-icon,
        .itinerary-card[data-route-type="scenic"] .stat-icon {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .itinerary-card[data-route-type="cultural"] .itinerary-icon,
        .itinerary-card[data-route-type="cultural"] .stat-icon {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }
        
        .itinerary-card[data-route-type="adventure"] .itinerary-icon,
        .itinerary-card[data-route-type="adventure"] .stat-icon {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
        
        .itinerary-card[data-route-type="culinary"] .itinerary-icon,
        .itinerary-card[data-route-type="culinary"] .stat-icon {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        
        .itinerary-card[data-route-type="romantic"] .itinerary-icon,
        .itinerary-card[data-route-type="romantic"] .stat-icon {
            background: linear-gradient(135deg, #ec4899, #db2777);
        }
        
        .itinerary-card[data-route-type="hidden_gems"] .itinerary-icon,
        .itinerary-card[data-route-type="hidden_gems"] .stat-icon {
            background: linear-gradient(135deg, #6366f1, #4f46e5);
        }

        /* Premium Travel Assistant Styles */
        .travel-assistant-section {
            margin-top: 4rem;
            position: relative;
        }

        .assistant-hero {
            position: relative;
            padding: 4rem 0;
            margin-bottom: 3rem;
            overflow: hidden;
            border-radius: 32px;
        }

        .hero-background {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, 
                rgba(102, 126, 234, 0.9) 0%, 
                rgba(118, 75, 162, 0.9) 50%, 
                rgba(240, 147, 251, 0.9) 100%);
            backdrop-filter: blur(20px);
        }

        .hero-background::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><defs><pattern id="travel-elements" width="50" height="50" patternUnits="userSpaceOnUse"><circle cx="10" cy="10" r="1" fill="rgba(255,255,255,0.1)"/><path d="M5,20 Q15,15 25,20 T45,20" stroke="rgba(255,255,255,0.08)" stroke-width="0.5" fill="none"/><polygon points="35,35 40,30 45,35 40,40" fill="rgba(255,255,255,0.05)"/><circle cx="40" cy="10" r="0.5" fill="rgba(255,255,255,0.08)"/><path d="M15,40 L20,35 L25,40 L20,45 Z" fill="rgba(255,255,255,0.03)"/></pattern></defs><rect width="200" height="200" fill="url(%23travel-elements)"/></svg>') repeat;
            opacity: 0.4;
        }

        /* Add floating travel elements */
        .hero-background::after {
            content: '';
            position: absolute;
            top: 10%;
            left: 10%;
            width: 80%;
            height: 80%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 600"><g opacity="0.1"><circle cx="100" cy="100" r="2" fill="white"/><circle cx="700" cy="150" r="1.5" fill="white"/><circle cx="200" cy="500" r="1" fill="white"/><circle cx="600" cy="450" r="2.5" fill="white"/><path d="M150,200 Q250,150 350,200 T550,200" stroke="white" stroke-width="1" fill="none"/><polygon points="650,300 660,290 670,300 660,310" fill="white"/><path d="M50,350 L100,300 L150,350 L100,400 Z" stroke="white" stroke-width="0.5" fill="none"/></g></svg>') no-repeat center;
            background-size: cover;
            pointer-events: none;
            animation: floatElements 20s ease-in-out infinite;
        }

        @keyframes floatElements {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        .hero-content {
            position: relative;
            z-index: 2;
        }

        .hero-title {
            font-family: 'Playfair Display', Georgia, serif;
            font-size: clamp(2.5rem, 5vw, 4rem);
            font-weight: 700;
            margin-bottom: 1rem;
            text-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .gradient-text {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .hero-subtitle {
            font-size: 1.25rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 400;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            padding: 0 1rem;
        }

        .feature-card {
            position: relative;
            background: var(--glass-bg);
            border-radius: 24px;
            padding: 2rem;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            cursor: pointer;
            overflow: hidden;
            min-height: 280px;
            animation: subtlePulse 4s ease-in-out infinite;
        }

        @keyframes subtlePulse {
            0%, 100% { box-shadow: 0 8px 32px rgba(0,0,0,0.15); }
            50% { box-shadow: 0 12px 40px rgba(102, 126, 234, 0.2); }
        }

        .feature-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .feature-card:hover::before {
            opacity: 1;
        }

        .feature-card:hover {
            transform: translateY(-12px);
            box-shadow: 
                0 32px 64px rgba(0,0,0,0.2),
                0 0 0 1px rgba(255,255,255,0.3);
        }

        .card-background {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0.15;
            border-radius: 24px;
            transition: opacity 0.3s ease;
        }

        .feature-card:hover .card-background {
            opacity: 0.25;
        }

        .card-icon {
            position: relative;
            z-index: 2;
            width: 80px;
            height: 80px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        /* Card backgrounds with travel-inspired imagery */
        .budget-card {
            background: linear-gradient(135deg, 
                rgba(102, 126, 234, 0.1), 
                rgba(118, 75, 162, 0.1)), 
                url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M10,50 Q30,10 50,50 T90,50" stroke="rgba(102,126,234,0.1)" stroke-width="2" fill="none"/><circle cx="20" cy="20" r="3" fill="rgba(102,126,234,0.1)"/><circle cx="80" cy="80" r="2" fill="rgba(102,126,234,0.1)"/></svg>');
        }
        
        .journal-card {
            background: linear-gradient(135deg, 
                rgba(245, 87, 108, 0.1), 
                rgba(229, 62, 62, 0.1)), 
                url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M20,20 L80,20 L80,80 L20,80 Z" stroke="rgba(245,87,108,0.1)" stroke-width="1" fill="none"/><line x1="30" y1="35" x2="70" y2="35" stroke="rgba(245,87,108,0.1)" stroke-width="1"/><line x1="30" y1="50" x2="60" y2="50" stroke="rgba(245,87,108,0.1)" stroke-width="1"/></svg>');
        }
        
        .packing-card {
            background: linear-gradient(135deg, 
                rgba(0, 242, 254, 0.1), 
                rgba(5, 150, 105, 0.1)), 
                url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect x="25" y="30" width="50" height="40" rx="5" stroke="rgba(0,242,254,0.1)" stroke-width="2" fill="none"/><rect x="40" y="25" width="20" height="10" stroke="rgba(0,242,254,0.1)" stroke-width="1" fill="none"/><circle cx="30" cy="75" r="3" fill="rgba(0,242,254,0.1)"/><circle cx="70" cy="75" r="3" fill="rgba(0,242,254,0.1)"/></svg>');
        }
        
        .transport-card {
            background: linear-gradient(135deg, 
                rgba(254, 214, 227, 0.2), 
                rgba(251, 191, 36, 0.1)), 
                url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M20,50 Q50,20 80,50" stroke="rgba(251,191,36,0.1)" stroke-width="2" fill="none"/><circle cx="20" cy="50" r="4" fill="rgba(251,191,36,0.1)"/><circle cx="80" cy="50" r="4" fill="rgba(251,191,36,0.1)"/><path d="M30,40 L70,40 L75,50 L25,50 Z" fill="rgba(254,214,227,0.1)"/></svg>');
        }
        
        .emergency-card {
            background: linear-gradient(135deg, 
                rgba(255, 154, 158, 0.1), 
                rgba(250, 204, 21, 0.1)), 
                url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="25" stroke="rgba(255,154,158,0.1)" stroke-width="2" fill="none"/><path d="M50,35 L55,45 L45,45 Z" fill="rgba(255,154,158,0.1)"/><circle cx="50" cy="55" r="2" fill="rgba(255,154,158,0.1)"/></svg>');
        }
        
        .experiences-card {
            background: linear-gradient(135deg, 
                rgba(252, 182, 159, 0.1), 
                rgba(255, 154, 158, 0.1)), 
                url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><polygon points="50,20 60,40 80,40 65,55 70,75 50,65 30,75 35,55 20,40 40,40" fill="rgba(252,182,159,0.1)" stroke="rgba(252,182,159,0.2)" stroke-width="1"/><circle cx="25" cy="25" r="2" fill="rgba(252,182,159,0.1)"/><circle cx="75" cy="80" r="1.5" fill="rgba(252,182,159,0.1)"/></svg>');
        }

        .budget-card .card-icon { color: #667eea; }
        .journal-card .card-icon { color: #f5576c; }
        .packing-card .card-icon { color: #00f2fe; }
        .transport-card .card-icon { color: #fed6e3; }
        .emergency-card .card-icon { color: #ff9a9e; }
        .experiences-card .card-icon { color: #fcb69f; }

        .feature-card:hover .card-icon {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 12px 32px rgba(0,0,0,0.2);
        }

        .card-content {
            position: relative;
            z-index: 2;
        }

        .card-content h3 {
            font-family: 'Playfair Display', Georgia, serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 0.5rem;
        }

        .card-content p {
            color: var(--gray-600);
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        .card-stats {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            line-height: 1;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--gray-500);
            margin-top: 0.25rem;
        }

        /* Loading and Performance Optimization Styles */
        .loading-spinner {
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 1rem;
            opacity: 0.7;
        }

        .loading-spinner i {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .no-data {
            color: var(--gray-500);
            font-style: italic;
            font-size: 0.9rem;
            text-align: center;
            padding: 0.5rem;
        }

        /* Performance: Optimize hover transitions */
        .feature-card {
            will-change: transform;
        }

        .feature-card:hover {
            will-change: auto;
        }

        /* Performance: GPU acceleration for animations */
        .card-icon {
            will-change: transform;
            transform: translateZ(0);
        }

        .progress-circle {
            transform: translateZ(0);
        }

        /* Icon rendering fixes */
        .fas, .far, .fab {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            display: inline-block;
            font-style: normal;
            font-variant: normal;
            text-rendering: auto;
            line-height: 1;
        }

        /* Fallback for missing icons */
        .card-icon i:before {
            content: attr(data-fallback);
        }

        /* Ensure icons are visible */
        .card-icon {
            font-family: "Font Awesome 6 Free", "Font Awesome 6 Pro", "Font Awesome 5 Free", "Font Awesome 5 Pro", system-ui, -apple-system, sans-serif;
            font-weight: 900;
        }

        /* Travel-themed decorative elements */
        .travel-decoration {
            position: absolute;
            pointer-events: none;
            opacity: 0.1;
            z-index: 1;
        }

        .travel-decoration.plane {
            top: 15%;
            right: 10%;
            animation: flyAcross 15s ease-in-out infinite;
        }

        .travel-decoration.car {
            bottom: 20%;
            left: 5%;
            animation: driveBy 12s ease-in-out infinite;
        }

        .travel-decoration.compass {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation: spin 20s linear infinite;
        }

        @keyframes flyAcross {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(15px); }
        }

        @keyframes driveBy {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(20px); }
        }

        @keyframes spin {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* Card hover effects with travel imagery */
        .feature-card::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.6s ease;
            pointer-events: none;
            z-index: 0;
        }

        .feature-card:hover::after {
            opacity: 1;
            animation: shimmer 1.5s ease-in-out;
        }

        @keyframes shimmer {
            0% { transform: rotate(0deg) scale(0.8); }
            50% { transform: rotate(180deg) scale(1.2); }
            100% { transform: rotate(360deg) scale(0.8); }
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .features-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
                padding: 0 1rem;
            }

            .feature-card {
                min-height: 240px;
                padding: 1.5rem;
            }

            .card-icon {
                width: 60px;
                height: 60px;
                font-size: 1.5rem;
                margin-bottom: 1rem;
            }

            .card-content h3 {
                font-size: 1.25rem;
                margin-bottom: 0.75rem;
            }

            .card-content p {
                font-size: 0.9rem;
                margin-bottom: 1rem;
            }

            .card-stats {
                gap: 1rem;
                margin-bottom: 1rem;
            }

            .stat-value {
                font-size: 1.25rem;
            }

            .premium-travel-features h2 {
                font-size: 2rem;
                margin-bottom: 1rem;
            }

            .premium-travel-features .subtitle {
                font-size: 1rem;
                margin-bottom: 2rem;
            }

            /* Mobile modal optimizations */
            .modal-content {
                width: 95vw;
                max-height: 90vh;
                margin: 5vh auto;
                overflow-y: auto;
            }

            .modal-header h3 {
                font-size: 1.25rem;
            }

            .modal-body {
                padding: 1.5rem;
            }

            .form-group {
                margin-bottom: 1rem;
            }

            .btn {
                padding: 0.75rem 1.5rem;
                font-size: 0.9rem;
            }

            /* Touch-friendly buttons */
            .feature-card {
                cursor: pointer;
                -webkit-tap-highlight-color: transparent;
            }

            .btn, .close-btn {
                min-height: 44px;
                min-width: 44px;
            }
        }

        @media (max-width: 480px) {
            .premium-travel-features {
                padding: 1rem 0.5rem;
            }

            .feature-card {
                padding: 1rem;
                min-height: 200px;
            }

            .card-icon {
                width: 50px;
                height: 50px;
                font-size: 1.25rem;
            }

            .card-content h3 {
                font-size: 1.1rem;
            }

            .premium-travel-features h2 {
                font-size: 1.75rem;
            }

            .modal-content {
                width: 98vw;
                margin: 2vh auto;
            }

            .modal-body {
                padding: 1rem;
            }
        }

        .card-progress {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .progress-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: conic-gradient(from 0deg, var(--primary) 0%, var(--gray-200) 0%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .progress-circle::before {
            content: '';
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: white;
            position: absolute;
        }

        .progress-value {
            position: relative;
            z-index: 2;
            font-weight: 700;
            font-size: 0.875rem;
            color: var(--primary);
        }

        .progress-label {
            font-size: 0.875rem;
            color: var(--gray-500);
        }

        .card-preview {
            margin-bottom: 1.5rem;
        }

        .preview-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .preview-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
        }

        .transport-preview {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .transport-mode {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .transport-mode i {
            width: 20px;
            color: var(--primary);
        }

        .emergency-quick-info {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .emergency-number {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 16px;
            border: 2px solid rgba(239, 68, 68, 0.2);
        }

        .emergency-number .number {
            font-size: 2rem;
            font-weight: 900;
            color: var(--danger);
            line-height: 1;
        }

        .emergency-number .label {
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-top: 0.25rem;
        }

        .experiences-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .experience-tag {
            padding: 0.375rem 0.75rem;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 20px;
            font-size: 0.75rem;
            color: var(--gray-600);
            font-weight: 500;
        }

        .card-action-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border: none;
            border-radius: 16px;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(99, 102, 241, 0.3);
        }

        .card-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.4);
        }

        .card-action-btn:active {
            transform: translateY(0);
        }

        .card-action-btn i {
            margin-right: 0.5rem;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .features-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
                padding: 0 0.5rem;
            }

            .feature-card {
                min-height: 240px;
                padding: 1.5rem;
            }

            .card-icon {
                width: 64px;
                height: 64px;
                font-size: 1.5rem;
            }

            .hero-title {
                font-size: 2rem;
            }

            .assistant-hero {
                padding: 3rem 0;
                margin-bottom: 2rem;
            }
        }

        /* Loading States */
        .loading {
            position: relative;
            pointer-events: none;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 24px;
            height: 24px;
            margin: -12px 0 0 -12px;
            border: 2px solid transparent;
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="hero-header">
        <div class="container">
            <h1 class="hero-title">
                <i class="fas fa-route me-2"></i>
                Your Perfect European Road Trip
            </h1>
            <p class="hero-subtitle">
                <span id="route-summary">5 amazing itineraries crafted just for you</span>
            </p>
        </div>
    </div>

    <div class="container mt-4">
        <a href="/" class="back-btn">
            <i class="fas fa-arrow-left"></i>
            Plan Another Trip
        </a>

        <!-- Premium Travel Assistant - Moved to top for visibility -->
        <div class="travel-assistant-section mt-4">
            <div class="assistant-hero">
                <div class="hero-background"></div>
                
                <!-- Decorative travel elements -->
                <div class="travel-decoration plane">
                    <i class="fas fa-plane" style="font-size: 2rem; color: rgba(255,255,255,0.15);"></i>
                </div>
                <div class="travel-decoration car">
                    <i class="fas fa-car-side" style="font-size: 1.5rem; color: rgba(255,255,255,0.12);"></i>
                </div>
                <div class="travel-decoration compass">
                    <i class="fas fa-compass" style="font-size: 3rem; color: rgba(255,255,255,0.08);"></i>
                </div>
                
                <div class="hero-content text-center">
                    <h2 class="hero-title">
                        <span class="gradient-text">ðŸš€ Premium Travel Features</span>
                    </h2>
                    <p class="hero-subtitle">Unlock powerful tools to enhance your European adventure</p>
                    <div class="hero-cta mt-3">
                        <small class="text-white-50">ðŸ‘† Click any card below to get started</small>
                    </div>
                </div>
            </div>

            <!-- Feature Grid -->
            <div class="features-grid">
                <!-- Budget Tracker Card -->
                <div class="feature-card budget-card" data-feature="budget">
                    <div class="card-background" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>
                    <div class="card-icon">
                        <i class="fas fa-euro-sign" data-fallback="â‚¬"></i>
                    </div>
                    <div class="card-content">
                        <h3>Smart Budget</h3>
                        <p>Track expenses and split costs with travel companions</p>
                        <div class="card-stats">
                            <div class="stat">
                                <div class="stat-value" id="budget-total">â‚¬0</div>
                                <div class="stat-label">Total Spent</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value" id="budget-expenses">0</div>
                                <div class="stat-label">Expenses</div>
                            </div>
                        </div>
                        <button class="card-action-btn" onclick="openBudgetModal()">
                            <i class="fas fa-plus"></i> Add Expense
                        </button>
                    </div>
                </div>

                <!-- Travel Journal Card -->
                <div class="feature-card journal-card" data-feature="journal">
                    <div class="card-background" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);"></div>
                    <div class="card-icon">
                        <i class="fas fa-book-open" data-fallback="ðŸ“–"></i>
                    </div>
                    <div class="card-content">
                        <h3>Travel Journal</h3>
                        <p>Capture memories and create your digital travel diary</p>
                        <div class="card-preview" id="journal-preview">
                            <div class="preview-item">
                                <div class="preview-icon"><i class="fas fa-camera"></i></div>
                                <span>Share your journey...</span>
                            </div>
                        </div>
                        <button class="card-action-btn" onclick="openJournalModal()">
                            <i class="fas fa-pen"></i> Write Entry
                        </button>
                    </div>
                </div>

                <!-- Smart Packing Card -->
                <div class="feature-card packing-card" data-feature="packing">
                    <div class="card-background" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);"></div>
                    <div class="card-icon">
                        <i class="fas fa-suitcase-rolling" data-fallback="ðŸ§³"></i>
                    </div>
                    <div class="card-content">
                        <h3>AI Packing</h3>
                        <p>Smart lists based on weather, activities, and trip duration</p>
                        <div class="card-progress" id="packing-progress">
                            <div class="progress-circle">
                                <div class="progress-value">0%</div>
                            </div>
                            <div class="progress-label">Packed</div>
                        </div>
                        <button class="card-action-btn" onclick="generateSmartPackingList()">
                            <i class="fas fa-magic"></i> Generate List
                        </button>
                    </div>
                </div>

                <!-- Transportation Card -->
                <div class="feature-card transport-card" data-feature="transport">
                    <div class="card-background" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);"></div>
                    <div class="card-icon">
                        <i class="fas fa-train" data-fallback="ðŸš†"></i>
                    </div>
                    <div class="card-content">
                        <h3>Local Transport</h3>
                        <p>Metro, buses, bike shares, and parking info for each city</p>
                        <div class="transport-preview" id="transport-preview">
                            <div class="transport-mode">
                                <i class="fas fa-subway"></i> Metro Available
                            </div>
                            <div class="transport-mode">
                                <i class="fas fa-bicycle"></i> Bike Share
                            </div>
                        </div>
                        <button class="card-action-btn" onclick="showTransportGuide()">
                            <i class="fas fa-map"></i> View Guide
                        </button>
                    </div>
                </div>

                <!-- Emergency Card -->
                <div class="feature-card emergency-card" data-feature="emergency">
                    <div class="card-background" style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);"></div>
                    <div class="card-icon">
                        <i class="fas fa-shield-heart" data-fallback="ðŸ›¡ï¸"></i>
                    </div>
                    <div class="card-content">
                        <h3>Safety First</h3>
                        <p>Emergency contacts, safety tips, and embassy information</p>
                        <div class="emergency-quick-info">
                            <div class="emergency-number">
                                <span class="number">112</span>
                                <span class="label">EU Emergency</span>
                            </div>
                        </div>
                        <button class="card-action-btn" onclick="showEmergencyInfo()">
                            <i class="fas fa-phone"></i> Show Contacts
                        </button>
                    </div>
                </div>

                <!-- Experiences Card -->
                <div class="feature-card experiences-card" data-feature="experiences">
                    <div class="card-background" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);"></div>
                    <div class="card-icon">
                        <i class="fas fa-compass" data-fallback="ðŸ§­"></i>
                    </div>
                    <div class="card-content">
                        <h3>Local Experiences</h3>
                        <p>Discover unique activities, tours, and hidden gems</p>
                        <div class="experiences-preview" id="experiences-preview">
                            <div class="experience-tag">Food Tours</div>
                            <div class="experience-tag">Museums</div>
                            <div class="experience-tag">Adventures</div>
                        </div>
                        <button class="card-action-btn" onclick="exploreExperiences()">
                            <i class="fas fa-search"></i> Explore
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Trip Itineraries Section -->
        <div id="itineraries-container" class="mt-5">
            <!-- Itineraries will be loaded here by JavaScript -->
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Route type configurations
        const routeTypeConfig = {
            'scenic': {
                icon: 'fa-mountain',
                color: '#10b981',
                mapColor: '#10b981'
            },
            'cultural': {
                icon: 'fa-monument',
                color: '#8b5cf6',
                mapColor: '#8b5cf6'
            },
            'adventure': {
                icon: 'fa-hiking',
                color: '#f59e0b',
                mapColor: '#f59e0b'
            },
            'culinary': {
                icon: 'fa-utensils',
                color: '#ef4444',
                mapColor: '#ef4444'
            },
            'romantic': {
                icon: 'fa-heart',
                color: '#ec4899',
                mapColor: '#ec4899'
            },
            'hidden_gems': {
                icon: 'fa-gem',
                color: '#6366f1',
                mapColor: '#6366f1'
            }
        };


        // Utility function to format numbers to 2 decimal places
        function formatNumber(num) {
            if (typeof num === 'number') {
                return Number(num.toFixed(2));
            }
            return num;
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadItineraries();
        });

        function loadItineraries() {
            const container = document.getElementById('itineraries-container');
            const routeSummary = document.getElementById('route-summary');
            
            // Try to get data from sessionStorage (from form submission)
            let itineraries = [];
            try {
                const storedData = sessionStorage.getItem('travelPlanResult');
                console.log('Stored data:', storedData);
                if (storedData) {
                    const data = JSON.parse(storedData);
                    console.log('Parsed data:', data);
                    itineraries = data.data?.routes || [];
                    console.log('Extracted routes:', itineraries);
                }
            } catch (e) {
                console.error('Error loading stored data:', e);
            }
            
            // Show message if no real data available (no fake data)
            if (itineraries.length === 0) {
                console.log('No real data found');
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: white;">
                        <h3>No Trip Results Available</h3>
                        <p>Please go back and plan a new trip to see results here.</p>
                        <a href="/" style="display: inline-flex; align-items: center; gap: 0.5rem; margin-top: 1rem; padding: 1rem 2rem; background: var(--primary); color: white; text-decoration: none; border-radius: 12px;">
                            <i class="fas fa-arrow-left"></i>
                            Plan New Trip
                        </a>
                    </div>
                `;
                return;
            } else {
                console.log('Using real data from API');
            }
            
            // Update summary
            routeSummary.textContent = `${itineraries.length} amazing itineraries crafted just for you`;
            
            // Render each itinerary
            container.innerHTML = '';
            itineraries.forEach((itinerary, index) => {
                const itineraryHtml = createItineraryCard(itinerary, index);
                container.insertAdjacentHTML('beforeend', itineraryHtml);
                
                // Initialize map for this itinerary
                setTimeout(() => initializeMap(itinerary, index), 100);
            });
        }

        function createItineraryCard(itinerary, index) {
            const config = routeTypeConfig[itinerary.route_type] || routeTypeConfig['scenic'];
            
            // Handle both API format and sample format
            const intermediateCities = itinerary.intermediate_cities || [];
            const citiesBadges = intermediateCities
                .map(city => {
                    const cityName = typeof city === 'string' ? city : (city.name || 'Unknown City');
                    return `<div class="city-badge">
                        <i class="fas fa-map-marker-alt"></i>
                        ${cityName}
                    </div>`;
                })
                .join('');
            
            // Handle highlights safely
            const highlights = itinerary.highlights || [];
            const highlightItems = highlights
                .map(highlight => `<div class="highlight-item">${highlight}</div>`)
                .join('');
            
            return `
                <div class="itinerary-card" data-route-type="${itinerary.route_type}">
                    <div class="itinerary-header">
                        <div class="itinerary-icon">
                            <i class="fas ${config.icon}"></i>
                        </div>
                        <div>
                            <h3 class="itinerary-title">${itinerary.name}</h3>
                            <p class="itinerary-subtitle">${itinerary.description}</p>
                        </div>
                    </div>
                    
                    <div class="route-stats">
                        <div class="stat-item">
                            <div class="stat-icon">
                                <i class="fas fa-route"></i>
                            </div>
                            <div class="stat-text">${formatNumber(itinerary.total_distance_km)} km</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-icon">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="stat-text">${formatNumber(itinerary.total_duration_hours)}h driving</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-icon">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="stat-text">${(itinerary.intermediate_cities || []).length + 2} stops</div>
                        </div>
                    </div>
                    
                    <div class="route-map" id="map-${index}"></div>
                    
                    <div class="cities-list">
                        <div class="city-badge">
                            <i class="fas fa-play"></i>
                            ${itinerary.start_city.name}
                        </div>
                        ${citiesBadges}
                        <div class="city-badge">
                            <i class="fas fa-flag-checkered"></i>
                            ${itinerary.end_city.name}
                        </div>
                    </div>
                    
                    <div class="highlights-section">
                        <h5 class="highlights-title">
                            <i class="fas fa-star"></i>
                            Route Highlights
                        </h5>
                        ${highlightItems}
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="fas fa-users me-1"></i>
                                Ideal for: ${itinerary.ideal_for}
                            </small>
                        </div>
                    </div>
                    
                    <div class="cost-estimate">
                        <h5 class="cost-title">
                            <i class="fas fa-euro-sign"></i>
                            Estimated Costs
                        </h5>
                        <div class="cost-breakdown">
                            <div class="cost-item">
                                <div class="cost-amount">â‚¬${formatNumber(itinerary.estimated_cost.fuel_estimate)}</div>
                                <div class="cost-label">Fuel</div>
                            </div>
                            <div class="cost-item">
                                <div class="cost-amount">â‚¬${formatNumber(itinerary.estimated_cost.accommodation_estimate)}</div>
                                <div class="cost-label">Accommodation</div>
                            </div>
                            <div class="cost-item">
                                <div class="cost-amount">â‚¬${formatNumber(itinerary.estimated_cost.total_estimate)}</div>
                                <div class="cost-label">Total Estimate</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="route-actions">
                        <button class="select-route-btn" onclick="selectRoute(${index})">
                            <i class="fas fa-check-circle me-2"></i>
                            Select This Route
                        </button>
                        <div class="route-action-buttons">
                            <button class="action-btn save-btn" onclick="saveTrip(${index})" title="Save Trip">
                                <i class="fas fa-heart"></i>
                            </button>
                            <button class="action-btn share-btn" onclick="shareTrip(${index})" title="Share Trip">
                                <i class="fas fa-share"></i>
                            </button>
                            <button class="action-btn weather-btn" onclick="checkWeather(${index})" title="Check Weather">
                                <i class="fas fa-cloud-sun"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function initializeMap(itinerary, index) {
            const mapId = `map-${index}`;
            const mapElement = document.getElementById(mapId);
            
            if (!mapElement) return;
            
            // Create map
            const map = L.map(mapId).setView([45.0, 7.0], 6);
            
            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);
            
            // Create route coordinates - handle different data formats
            const startCoords = Array.isArray(itinerary.start_city.coordinates) 
                ? itinerary.start_city.coordinates 
                : [itinerary.start_city.coordinates.latitude, itinerary.start_city.coordinates.longitude];
            
            const endCoords = Array.isArray(itinerary.end_city.coordinates)
                ? itinerary.end_city.coordinates
                : [itinerary.end_city.coordinates.latitude, itinerary.end_city.coordinates.longitude];
            
            const intermediateCoords = (itinerary.intermediate_cities || []).map(city => {
                if (typeof city === 'string') return null; // Skip string cities
                if (Array.isArray(city.coordinates)) return city.coordinates;
                if (city.coordinates && city.coordinates.latitude) {
                    return [city.coordinates.latitude, city.coordinates.longitude];
                }
                return null;
            }).filter(coord => coord !== null);
            
            const routeCoords = [startCoords, ...intermediateCoords, endCoords];
            
            // Add route line
            const config = routeTypeConfig[itinerary.route_type] || routeTypeConfig['scenic'];
            const routeLine = L.polyline(routeCoords, {
                color: config.mapColor,
                weight: 4,
                opacity: 0.8
            }).addTo(map);
            
            // Add markers
            const startIcon = L.divIcon({
                html: '<i class="fas fa-play" style="color: #10b981;"></i>',
                iconSize: [20, 20],
                className: 'custom-div-icon'
            });
            
            const endIcon = L.divIcon({
                html: '<i class="fas fa-flag-checkered" style="color: #ef4444;"></i>',
                iconSize: [20, 20],
                className: 'custom-div-icon'
            });
            
            const wayIcon = L.divIcon({
                html: '<i class="fas fa-map-marker-alt" style="color: ' + config.mapColor + ';"></i>',
                iconSize: [20, 20],
                className: 'custom-div-icon'
            });
            
            // Add start marker
            L.marker(startCoords, {icon: startIcon})
                .addTo(map)
                .bindPopup(`<b>Start:</b> ${itinerary.start_city.name}`);
            
            // Add intermediate markers
            (itinerary.intermediate_cities || []).forEach(city => {
                if (typeof city === 'string') return; // Skip string cities
                
                let cityCoords;
                if (Array.isArray(city.coordinates)) {
                    cityCoords = city.coordinates;
                } else if (city.coordinates && city.coordinates.latitude) {
                    cityCoords = [city.coordinates.latitude, city.coordinates.longitude];
                } else {
                    return; // Skip if no valid coordinates
                }
                
                const cityTypes = city.types ? city.types.join(', ') : 'Intermediate stop';
                L.marker(cityCoords, {icon: wayIcon})
                    .addTo(map)
                    .bindPopup(`<b>${city.name}</b><br/>${cityTypes}`);
            });
            
            // Add end marker
            L.marker(endCoords, {icon: endIcon})
                .addTo(map)
                .bindPopup(`<b>Destination:</b> ${itinerary.end_city.name}`);
            
            // Fit map to route
            map.fitBounds(routeLine.getBounds(), {padding: [20, 20]});
        }

        function selectRoute(index) {
            // Get the selected route data
            let itineraries = [];
            try {
                const storedData = sessionStorage.getItem('travelPlanResult');
                if (storedData) {
                    const data = JSON.parse(storedData);
                    itineraries = data.data?.routes || [];
                }
            } catch (e) {
                console.error('Error loading stored data:', e);
            }
            
            // If no real data available, show message instead of fake data
            if (itineraries.length === 0) {
                document.getElementById('routeContainer').innerHTML = `
                    <div class="no-results-message">
                        <h3>No Trip Results Available</h3>
                        <p>Please go back and plan a new trip to see results here.</p>
                        <a href="/" class="back-btn">
                            <i class="fas fa-arrow-left"></i>
                            Plan New Trip
                        </a>
                    </div>
                `;
                return;
            }
            
            if (itineraries[index]) {
                // Store the selected route in sessionStorage
                const selectedRoute = itineraries[index];
                sessionStorage.setItem('selectedRoute', JSON.stringify(selectedRoute));
                
                // Navigate to trip details page
                window.location.href = '/trip-details';
            } else {
                alert('Route data not found. Please try again.');
            }
        }

        // Load real hotel and restaurant data
        async function loadTripData(cities) {
            try {
                console.log('Loading real trip data for cities:', cities);
                
                const response = await fetch('/api/trip-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ cities: cities })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Received trip data:', data);
                    return data.data || {};
                } else {
                    console.error('Trip data API error:', response.status);
                    return {};
                }
            } catch (error) {
                console.error('Failed to load trip data:', error);
                return {};
            }
        }

        // Enhanced functionality for new features
        async function saveTrip(index) {
            try {
                let itineraries = getItineraries();
                const selectedRoute = itineraries[index];
                
                if (!selectedRoute) {
                    alert('Trip data not found');
                    return;
                }
                
                const tripName = prompt('Give your trip a name:', selectedRoute.name);
                if (!tripName) return;
                
                const response = await fetch('/api/save-trip', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        trip_name: tripName,
                        trip_data: selectedRoute,
                        is_favorite: true
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Update button state
                    const saveBtn = document.querySelector(`[onclick="saveTrip(${index})"]`);
                    saveBtn.classList.add('saved');
                    saveBtn.innerHTML = '<i class="fas fa-check"></i>';
                    saveBtn.title = 'Trip Saved!';
                    
                    alert('Trip saved successfully!');
                } else {
                    alert(data.error || 'Failed to save trip');
                }
                
            } catch (error) {
                console.error('Save trip error:', error);
                alert('Please log in to save trips');
            }
        }
        
        async function shareTrip(index) {
            try {
                let itineraries = getItineraries();
                const selectedRoute = itineraries[index];
                
                if (!selectedRoute) {
                    alert('Trip data not found');
                    return;
                }
                
                // For now, share via URL
                const shareData = {
                    title: selectedRoute.name,
                    text: `Check out this amazing ${selectedRoute.route_type} route from ${selectedRoute.start_city.name} to ${selectedRoute.end_city.name}!`,
                    url: window.location.href
                };
                
                if (navigator.share) {
                    await navigator.share(shareData);
                } else {
                    // Fallback: copy to clipboard
                    const shareText = `${shareData.text} ${shareData.url}`;
                    await navigator.clipboard.writeText(shareText);
                    alert('Trip details copied to clipboard!');
                }
                
            } catch (error) {
                console.error('Share trip error:', error);
                alert('Sharing not supported on this device');
            }
        }
        
        async function checkWeather(index) {
            try {
                let itineraries = getItineraries();
                const selectedRoute = itineraries[index];
                
                if (!selectedRoute) {
                    alert('Trip data not found');
                    return;
                }
                
                // Get all cities in the route
                const cities = [
                    selectedRoute.start_city,
                    ...selectedRoute.intermediate_cities,
                    selectedRoute.end_city
                ].map(city => ({
                    name: city.name,
                    coordinates: city.coordinates
                }));
                
                const response = await fetch('/api/weather/route', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ cities: cities })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displayWeatherModal(data.weather_data, data.analysis);
                } else {
                    alert('Weather information unavailable');
                }
                
            } catch (error) {
                console.error('Weather check error:', error);
                alert('Weather service unavailable');
            }
        }
        
        function displayWeatherModal(weatherData, analysis) {
            let weatherHtml = '<div style="max-height: 400px; overflow-y: auto;">';
            
            // Overall conditions
            weatherHtml += `<h4 style="color: #6366f1; margin-bottom: 1rem;">
                <i class="fas fa-cloud-sun me-2"></i>
                Weather Conditions: ${analysis.overall_conditions.toUpperCase()}
            </h4>`;
            
            // Weather alerts
            if (analysis.alerts && analysis.alerts.length > 0) {
                weatherHtml += '<div style="background: #fee2e2; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">';
                weatherHtml += '<h5 style="color: #dc2626; margin-bottom: 0.5rem;"><i class="fas fa-exclamation-triangle me-2"></i>Weather Alerts</h5>';
                analysis.alerts.forEach(alert => {
                    weatherHtml += `<p style="margin: 0.25rem 0; color: #991b1b;">â€¢ ${alert}</p>`;
                });
                weatherHtml += '</div>';
            }
            
            // Current weather for each city
            weatherHtml += '<h5 style="margin: 1.5rem 0 1rem 0;">Current Weather</h5>';
            Object.entries(weatherData).forEach(([city, weather]) => {
                const current = weather.current;
                weatherHtml += `
                    <div style="background: rgba(99, 102, 241, 0.1); padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem;">
                        <strong>${city}</strong>: ${current.temperature}Â°C, ${current.condition}
                        <br><small>Feels like ${current.feels_like}Â°C â€¢ Humidity ${current.humidity}% â€¢ Wind ${current.wind_speed} m/s</small>
                    </div>
                `;
            });
            
            // Recommendations
            if (analysis.recommendations && analysis.recommendations.length > 0) {
                weatherHtml += '<h5 style="margin: 1.5rem 0 1rem 0;">Travel Recommendations</h5>';
                analysis.recommendations.forEach(rec => {
                    weatherHtml += `<p style="margin: 0.25rem 0;">â€¢ ${rec}</p>`;
                });
            }
            
            weatherHtml += '</div>';
            
            // Create and show modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.7); z-index: 10000; display: flex; 
                align-items: center; justify-content: center; padding: 2rem;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 20px; padding: 2rem; max-width: 600px; width: 100%;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="margin: 0; color: #1e293b;">Weather Forecast</h3>
                        <button onclick="this.closest('[style*=fixed]').remove()" 
                                style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748b;">Ã—</button>
                    </div>
                    ${weatherHtml}
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function getItineraries() {
            // Try to get data from sessionStorage first
            try {
                const storedData = sessionStorage.getItem('travelPlanResult');
                if (storedData) {
                    const data = JSON.parse(storedData);
                    return data.data?.routes || [];
                }
            } catch (e) {
                console.error('Error loading stored data:', e);
            }
            
            // Return empty array if no real data
            return [];
        }
        
        // Premium Travel Assistant JavaScript
        let currentTripId = null;
        let isAuthenticated = false;
        let currentUser = null;
        
        // Performance optimization: Cache for API responses
        const apiCache = new Map();
        const cacheTimeout = 5 * 60 * 1000; // 5 minutes
        
        // Performance optimization: Debounce function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // Performance optimization: Request queue to prevent duplicate requests
        const activeRequests = new Set();
        
        // Performance optimization: Cached API wrapper
        async function cachedFetch(url, options = {}) {
            const cacheKey = `${url}_${JSON.stringify(options)}`;
            
            // Check if request is already active
            if (activeRequests.has(cacheKey)) {
                return null; // Skip duplicate requests
            }
            
            // Check cache first
            const cached = apiCache.get(cacheKey);
            if (cached && Date.now() - cached.timestamp < cacheTimeout) {
                return cached.data;
            }
            
            try {
                activeRequests.add(cacheKey);
                const response = await fetch(url, {
                    credentials: 'same-origin',
                    ...options
                });
                
                if (response.ok) {
                    const data = await response.json();
                    // Cache successful response
                    apiCache.set(cacheKey, {
                        data: data,
                        timestamp: Date.now()
                    });
                    return data;
                }
                return null;
            } catch (error) {
                console.log(`API request failed: ${url}`, error);
                return null;
            } finally {
                activeRequests.delete(cacheKey);
            }
        }

        // Check authentication status with caching
        async function checkAuth() {
            try {
                const data = await cachedFetch('/auth/check');
                if (data) {
                    isAuthenticated = data.authenticated;
                    currentUser = data.user;
                    return true;
                } else {
                    isAuthenticated = false;
                    currentUser = null;
                    return false;
                }
            } catch (error) {
                console.log('Auth check failed, assuming not authenticated');
                isAuthenticated = false;
                currentUser = null;
                return false;
            }
        }

        // Show authentication required message
        function showAuthRequired() {
            const modal = document.createElement('div');
            modal.className = 'auth-modal';
            modal.innerHTML = `
                <div class="auth-modal-content">
                    <div class="auth-modal-header">
                        <h3><i class="fas fa-lock me-2"></i>Login Required</h3>
                        <button onclick="this.closest('.auth-modal').remove()" class="close-btn">&times;</button>
                    </div>
                    <div class="auth-modal-body">
                        <p>Please log in to access premium travel features and save your data.</p>
                        <div class="auth-actions">
                            <a href="/auth/login" class="btn btn-primary">Login</a>
                            <a href="/auth/register" class="btn btn-outline-primary">Sign Up</a>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Add styles
            const style = document.createElement('style');
            style.textContent = `
                .auth-modal {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.8);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                }
                .auth-modal-content {
                    background: white;
                    border-radius: 20px;
                    max-width: 400px;
                    width: 90%;
                    overflow: hidden;
                    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                }
                .auth-modal-header {
                    background: linear-gradient(135deg, var(--primary), var(--secondary));
                    color: white;
                    padding: 1.5rem;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }
                .auth-modal-body {
                    padding: 2rem;
                    text-align: center;
                }
                .auth-actions {
                    display: flex;
                    gap: 1rem;
                    margin-top: 1.5rem;
                }
                .close-btn {
                    background: none;
                    border: none;
                    color: white;
                    font-size: 1.5rem;
                    cursor: pointer;
                    padding: 0;
                    width: 30px;
                    height: 30px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    border-radius: 50%;
                    transition: background 0.2s;
                }
                .close-btn:hover {
                    background: rgba(255,255,255,0.2);
                }
            `;
            document.head.appendChild(style);
        }

        // Initialize enhanced features when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            // Check authentication
            await checkAuth();
            
            // Initialize trip ID from saved trip data
            const savedTrip = sessionStorage.getItem('selectedRoute');
            if (savedTrip) {
                try {
                    const tripData = JSON.parse(savedTrip);
                    currentTripId = tripData.id || 1;
                } catch (e) {
                    currentTripId = 1;
                }
            } else {
                currentTripId = 1;
            }

            // Load initial data for cards with optimized performance
            if (isAuthenticated) {
                // Show loading states immediately
                showCardLoadingStates();
                
                // Use requestAnimationFrame for better performance and reduce delays
                requestAnimationFrame(() => {
                    loadBudgetSummaryCard();
                    setTimeout(() => loadPackingProgressCard(), 50);
                    setTimeout(() => loadTransportPreview(), 100);
                    setTimeout(() => loadJournalPreview(), 150);
                });
            }
        });

        // Show loading states for all cards
        function showCardLoadingStates() {
            const loadingHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></div>';
            
            const budgetTotal = document.getElementById('budget-total');
            const budgetExpenses = document.getElementById('budget-expenses');
            const progressValue = document.querySelector('.progress-value');
            const transportPreview = document.getElementById('transport-preview');
            const journalPreview = document.getElementById('journal-preview');
            
            if (budgetTotal) budgetTotal.innerHTML = loadingHTML;
            if (budgetExpenses) budgetExpenses.innerHTML = loadingHTML;
            if (progressValue) progressValue.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            if (transportPreview) transportPreview.innerHTML = loadingHTML;
            if (journalPreview) journalPreview.innerHTML = loadingHTML;
        }

        // Card-specific loader functions with performance optimization
        async function loadBudgetSummaryCard() {
            try {
                const summary = await cachedFetch(`/api/enhanced/budget/summary/${currentTripId}`);
                if (summary) {
                    const budgetTotal = document.getElementById('budget-total');
                    const budgetExpenses = document.getElementById('budget-expenses');
                    
                    if (budgetTotal) budgetTotal.textContent = `â‚¬${summary.total_spent?.toFixed(0) || '0'}`;
                    if (budgetExpenses) budgetExpenses.textContent = summary.expense_count || 0;
                } else {
                    // Show default values if no data
                    const budgetTotal = document.getElementById('budget-total');
                    const budgetExpenses = document.getElementById('budget-expenses');
                    
                    if (budgetTotal) budgetTotal.textContent = 'â‚¬0';
                    if (budgetExpenses) budgetExpenses.textContent = '0';
                }
            } catch (error) {
                console.log('Budget summary not available');
                // Show error state or default values
                const budgetTotal = document.getElementById('budget-total');
                const budgetExpenses = document.getElementById('budget-expenses');
                
                if (budgetTotal) budgetTotal.textContent = 'â‚¬0';
                if (budgetExpenses) budgetExpenses.textContent = '0';
            }
        }

        async function loadPackingProgressCard() {
            try {
                const data = await cachedFetch(`/api/enhanced/packing/lists/${currentTripId}`);
                if (data) {
                    const lists = data.packing_lists || [];
                    const progressValue = document.querySelector('.progress-value');
                    const progressCircle = document.querySelector('.progress-circle');
                    
                    if (lists.length > 0) {
                        const totalPacked = lists.reduce((sum, list) => sum + (list.progress?.packed || 0), 0);
                        const totalItems = lists.reduce((sum, list) => sum + (list.progress?.total || 0), 0);
                        const percentage = totalItems > 0 ? Math.round((totalPacked / totalItems) * 100) : 0;
                        
                        if (progressValue) progressValue.textContent = `${percentage}%`;
                        if (progressCircle) {
                            progressCircle.style.background = 
                                `conic-gradient(from 0deg, var(--primary) ${percentage * 3.6}deg, var(--gray-200) ${percentage * 3.6}deg)`;
                        }
                    } else {
                        if (progressValue) progressValue.textContent = '0%';
                        if (progressCircle) {
                            progressCircle.style.background = 'conic-gradient(from 0deg, var(--gray-200) 360deg)';
                        }
                    }
                } else {
                    // Show default state
                    const progressValue = document.querySelector('.progress-value');
                    const progressCircle = document.querySelector('.progress-circle');
                    
                    if (progressValue) progressValue.textContent = '0%';
                    if (progressCircle) {
                        progressCircle.style.background = 'conic-gradient(from 0deg, var(--gray-200) 360deg)';
                    }
                }
            } catch (error) {
                console.log('Packing progress not available');
                // Show default state on error
                const progressValue = document.querySelector('.progress-value');
                if (progressValue) progressValue.textContent = '0%';
            }
        }

        async function loadTransportPreview() {
            const itineraries = getItineraries();
            const preview = document.getElementById('transport-preview');
            
            if (itineraries.length === 0 || !preview) {
                if (preview) {
                    preview.innerHTML = '<div class="no-data">No route data available</div>';
                }
                return;
            }

            const cities = [itineraries[0].start_city, ...itineraries[0].intermediate_cities, itineraries[0].end_city];
            if (cities.length > 0) {
                try {
                    const data = await cachedFetch(`/api/enhanced/transport/city/${encodeURIComponent(cities[0].name)}`);
                    if (data && preview) {
                        preview.innerHTML = `
                            <div class="transport-mode">
                                <i class="fas fa-subway"></i> ${data.public_transit?.available ? 'Metro Available' : 'Limited Transit'}
                            </div>
                            <div class="transport-mode">
                                <i class="fas fa-bicycle"></i> ${data.bike_share?.available ? 'Bike Share' : 'No Bike Share'}
                            </div>
                        `;
                    } else if (preview) {
                        preview.innerHTML = `
                            <div class="transport-mode">
                                <i class="fas fa-car"></i> Road transport available
                            </div>
                            <div class="transport-mode">
                                <i class="fas fa-walking"></i> Walking routes
                            </div>
                        `;
                    }
                } catch (error) {
                    console.log('Transport preview not available');
                    if (preview) {
                        preview.innerHTML = '<div class="no-data">Transport info unavailable</div>';
                    }
                }
            }
        }

        async function loadJournalPreview() {
            try {
                const data = await cachedFetch(`/api/enhanced/journal/entries/${currentTripId}`);
                const preview = document.getElementById('journal-preview');
                
                if (data && preview) {
                    const entries = data.entries || [];
                    
                    if (entries.length > 0) {
                        const latestEntry = entries[0];
                        preview.innerHTML = `
                            <div class="preview-item">
                                <div class="preview-icon"><i class="fas fa-pen"></i></div>
                                <span>${latestEntry.title.substring(0, 30)}...</span>
                            </div>
                        `;
                    } else {
                        preview.innerHTML = `
                            <div class="preview-item">
                                <div class="preview-icon"><i class="fas fa-plus"></i></div>
                                <span>Start your travel journal</span>
                            </div>
                        `;
                    }
                } else if (preview) {
                    preview.innerHTML = `
                        <div class="preview-item">
                            <div class="preview-icon"><i class="fas fa-plus"></i></div>
                            <span>Start your travel journal</span>
                        </div>
                    `;
                }
            } catch (error) {
                console.log('Journal preview not available');
                const preview = document.getElementById('journal-preview');
                if (preview) {
                    preview.innerHTML = '<div class="no-data">Journal unavailable</div>';
                }
            }
        }

        // Premium Modal Functions
        function openBudgetModal() {
            if (!isAuthenticated) {
                showAuthRequired();
                return;
            }
            
            const modal = createPremiumModal('Budget Tracker', `
                <div class="expense-form">
                    <div class="form-group">
                        <label>Category</label>
                        <select id="expense-category" class="form-control">
                            <option value="transport">ðŸš— Transport</option>
                            <option value="food">ðŸ• Food & Dining</option>
                            <option value="accommodation">ðŸ¨ Accommodation</option>
                            <option value="activities">ðŸŽ­ Activities</option>
                            <option value="shopping">ðŸ›ï¸ Shopping</option>
                            <option value="other">ðŸ“¦ Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" id="expense-description" class="form-control" placeholder="e.g. Dinner at Italian restaurant">
                    </div>
                    <div class="form-group">
                        <label>Amount (EUR)</label>
                        <input type="number" id="expense-amount" class="form-control" step="0.01" placeholder="25.50">
                    </div>
                </div>
            `, [
                {
                    text: 'Add Expense',
                    class: 'btn-primary',
                    onclick: 'addExpenseFromModal()'
                }
            ]);
        }

        async function addExpenseFromModal() {
            const category = document.getElementById('expense-category').value;
            const description = document.getElementById('expense-description').value;
            const amount = parseFloat(document.getElementById('expense-amount').value);

            if (!category || !description || !amount) {
                showToast('Please fill in all fields', 'error');
                return;
            }

            try {
                const btn = event.target;
                btn.classList.add('loading');
                btn.disabled = true;

                const response = await fetch('/api/enhanced/budget/expenses', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        trip_id: currentTripId,
                        category: category,
                        description: description,
                        amount: amount,
                        paid_by: currentUser?.id || 1,
                        currency: 'EUR'
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        showToast('Expense added successfully!', 'success');
                        loadBudgetSummaryCard();
                        document.querySelector('.auth-modal').remove();
                    } else {
                        showToast('Error: ' + (result.error || 'Failed to add expense'), 'error');
                    }
                } else {
                    showToast('Authentication error. Please refresh and try again.', 'error');
                }
            } catch (error) {
                console.error('Error adding expense:', error);
                showToast('Error adding expense. Please try again.', 'error');
            } finally {
                const btn = event.target;
                btn.classList.remove('loading');
                btn.disabled = false;
            }
        }

        async function loadExpenses() {
            try {
                const response = await fetch(`/api/enhanced/budget/expenses/${currentTripId}`, {
                    credentials: 'same-origin'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayExpenses(data.expenses || []);
                    loadBudgetSummary();
                }
            } catch (error) {
                console.error('Error loading expenses:', error);
            }
        }

        function displayExpenses(expenses) {
            const container = document.getElementById('expenses-list');
            if (expenses.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-receipt fa-2x mb-2"></i>
                        <p>No expenses added yet. Start tracking your trip spending!</p>
                    </div>
                `;
                return;
            }

            const expensesHtml = expenses.map(expense => `
                <div class="expense-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${expense.description}</strong>
                            <br><small class="text-muted">${expense.expense_category} â€¢ ${new Date(expense.expense_date).toLocaleDateString()}</small>
                        </div>
                        <div class="text-end">
                            <span class="fw-bold text-primary">â‚¬${expense.amount.toFixed(2)}</span>
                            <br><small class="text-muted">by ${expense.paid_by_name}</small>
                        </div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = expensesHtml;
        }

        async function loadBudgetSummary() {
            try {
                const response = await fetch(`/api/enhanced/budget/summary/${currentTripId}`, {
                    credentials: 'same-origin'
                });
                
                if (response.ok) {
                    const summary = await response.json();
                    document.getElementById('total-spent').textContent = `â‚¬${summary.total_spent?.toFixed(2) || '0.00'}`;
                    document.getElementById('expense-count').textContent = summary.expense_count || 0;
                }
            } catch (error) {
                console.error('Error loading budget summary:', error);
            }
        }

        // Travel Journal Functions
        async function addJournalEntry() {
            const title = prompt('Entry title:');
            if (!title) return;
            
            const content = prompt('What happened today?');
            if (!content) return;
            
            try {
                const response = await fetch('/api/enhanced/journal/entries', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        trip_id: currentTripId,
                        entry_type: 'text',
                        title: title,
                        content: content,
                        is_private: false
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        alert('Journal entry added!');
                        loadJournalEntries();
                    } else {
                        alert('Error: ' + (result.error || 'Failed to add entry'));
                    }
                } else {
                    alert('Please log in to add journal entries');
                }
            } catch (error) {
                console.error('Error adding journal entry:', error);
                alert('Error adding entry. Please try again.');
            }
        }

        async function loadJournalEntries() {
            try {
                const response = await fetch(`/api/enhanced/journal/entries/${currentTripId}`, {
                    credentials: 'same-origin'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayJournalEntries(data.entries || []);
                }
            } catch (error) {
                console.error('Error loading journal entries:', error);
            }
        }

        function displayJournalEntries(entries) {
            const container = document.getElementById('journal-entries');
            if (entries.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-pen-fancy fa-2x mb-2"></i>
                        <p>Start documenting your journey! Add photos, thoughts, and memories.</p>
                    </div>
                `;
                return;
            }

            const entriesHtml = entries.map(entry => `
                <div class="journal-entry">
                    <h5>${entry.title}</h5>
                    <p class="mb-2">${entry.content}</p>
                    <small class="text-muted">
                        <i class="fas fa-calendar me-1"></i>
                        ${new Date(entry.entry_date).toLocaleDateString()}
                        by ${entry.username}
                    </small>
                </div>
            `).join('');

            container.innerHTML = entriesHtml;
        }

        // Smart Packing Functions
        async function generatePackingList() {
            const itineraries = getItineraries();
            if (itineraries.length === 0) {
                alert('Please plan a trip first to generate a packing list');
                return;
            }

            const selectedRoute = itineraries[0]; // Use first route
            
            try {
                const response = await fetch('/api/enhanced/packing/generate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        trip_id: currentTripId,
                        trip_data: {
                            total_duration_hours: selectedRoute.total_duration || 168, // 7 days default
                            route_type: selectedRoute.route_type,
                            weather_data: {
                                average_temperature: 20,
                                precipitation_chance: 30
                            },
                            activities: ['sightseeing', 'cultural']
                        }
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        alert('Smart packing list generated!');
                        loadPackingLists();
                    } else {
                        alert('Error: ' + (result.error || 'Failed to generate list'));
                    }
                } else {
                    alert('Please log in to generate packing lists');
                }
            } catch (error) {
                console.error('Error generating packing list:', error);
                alert('Error generating list. Please try again.');
            }
        }

        async function loadPackingLists() {
            try {
                const response = await fetch(`/api/enhanced/packing/lists/${currentTripId}`, {
                    credentials: 'same-origin'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayPackingLists(data.packing_lists || []);
                }
            } catch (error) {
                console.error('Error loading packing lists:', error);
            }
        }

        function displayPackingLists(lists) {
            const container = document.getElementById('packing-lists');
            if (lists.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-luggage-cart fa-2x mb-2"></i>
                        <p>Generate a smart packing list based on your destination's weather and activities!</p>
                    </div>
                `;
                return;
            }

            const listsHtml = lists.map(list => {
                const items = JSON.parse(list.items || '[]');
                const itemsHtml = items.map(item => `
                    <div class="packing-item ${item.packed ? 'packed' : ''}" onclick="togglePackingItem(${list.id}, '${item.item}', ${!item.packed})">
                        <input type="checkbox" class="packing-checkbox" ${item.packed ? 'checked' : ''} readonly>
                        <span>${item.item} (${item.quantity})</span>
                        <small class="ms-auto text-muted">${item.category}</small>
                    </div>
                `).join('');

                return `
                    <div class="mb-4">
                        <h5>${list.list_name}</h5>
                        <div class="progress mb-3" style="height: 8px;">
                            <div class="progress-bar" style="width: ${list.progress?.percentage || 0}%"></div>
                        </div>
                        <p class="text-muted mb-3">${list.progress?.packed || 0} of ${list.progress?.total || 0} items packed</p>
                        ${itemsHtml}
                    </div>
                `;
            }).join('');

            container.innerHTML = listsHtml;
        }

        async function togglePackingItem(listId, itemName, packed) {
            try {
                const response = await fetch(`/api/enhanced/packing/items/${listId}/status`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        item_name: itemName,
                        packed: packed
                    })
                });

                if (response.ok) {
                    loadPackingLists(); // Reload to update UI
                }
            } catch (error) {
                console.error('Error updating packing item:', error);
            }
        }

        // Transportation Functions
        async function loadTransportationInfo() {
            const itineraries = getItineraries();
            if (itineraries.length === 0) return;

            const cities = [itineraries[0].start_city, ...itineraries[0].intermediate_cities, itineraries[0].end_city];
            const container = document.getElementById('transportation-info');
            
            let transportHtml = '<div class="row">';
            
            for (const city of cities) {
                try {
                    const response = await fetch(`/api/enhanced/transport/city/${encodeURIComponent(city.name)}`, {
                        credentials: 'same-origin'
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        transportHtml += createTransportCard(city.name, data);
                    }
                } catch (error) {
                    console.error(`Error loading transport for ${city.name}:`, error);
                }
            }
            
            transportHtml += '</div>';
            container.innerHTML = transportHtml;
        }

        function createTransportCard(cityName, transportData) {
            return `
                <div class="col-md-6 mb-3">
                    <div class="transport-card">
                        <div class="d-flex align-items-center mb-3">
                            <div class="transport-icon me-3">
                                <i class="fas fa-subway"></i>
                            </div>
                            <h5 class="mb-0">${cityName}</h5>
                        </div>
                        <div class="transport-details">
                            <p><strong>Public Transit:</strong> ${transportData.public_transit?.available ? 'Available' : 'Limited'}</p>
                            <p><strong>Bike Share:</strong> ${transportData.bike_share?.available ? 'Yes' : 'No'}</p>
                            <p><strong>Parking:</strong> Available from â‚¬${transportData.parking?.street_parking?.average_price || 'N/A'}/hour</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Emergency Information Functions
        async function loadEmergencyInfo() {
            const itineraries = getItineraries();
            if (itineraries.length === 0) return;

            const countries = [...new Set([itineraries[0].start_city, ...itineraries[0].intermediate_cities, itineraries[0].end_city]
                .map(city => getCountryFromCity(city.name)))];
            
            const container = document.getElementById('emergency-info');
            let emergencyHtml = '';
            
            for (const country of countries) {
                try {
                    const response = await fetch(`/api/enhanced/emergency/contacts?country=${encodeURIComponent(country)}`, {
                        credentials: 'same-origin'
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        emergencyHtml += createEmergencyCard(country, data.contacts || []);
                    }
                } catch (error) {
                    console.error(`Error loading emergency info for ${country}:`, error);
                }
            }
            
            container.innerHTML = emergencyHtml || `
                <div class="text-center py-4 text-muted">
                    <i class="fas fa-phone fa-2x mb-2"></i>
                    <p>Emergency information will be loaded based on your destinations</p>
                </div>
            `;
        }

        function createEmergencyCard(country, contacts) {
            const contactsHtml = contacts.slice(0, 3).map(contact => `
                <div class="mb-2">
                    <strong>${contact.service_name}:</strong> ${contact.phone_number}
                    ${contact.address ? `<br><small class="text-muted">${contact.address}</small>` : ''}
                </div>
            `).join('');

            return `
                <div class="emergency-card mb-3">
                    <h5><i class="fas fa-flag me-2"></i>${country}</h5>
                    ${contactsHtml}
                    <small class="text-muted">Emergency services: 112 (EU standard)</small>
                </div>
            `;
        }

        function getCountryFromCity(cityName) {
            // Simplified country detection - in a real app, this would be more sophisticated
            const cityCountryMap = {
                'Paris': 'France', 'Lyon': 'France', 'Marseille': 'France', 'Nice': 'France',
                'Rome': 'Italy', 'Milan': 'Italy', 'Venice': 'Italy', 'Florence': 'Italy',
                'Madrid': 'Spain', 'Barcelona': 'Spain', 'Seville': 'Spain', 'Valencia': 'Spain',
                'Berlin': 'Germany', 'Munich': 'Germany', 'Hamburg': 'Germany', 'Cologne': 'Germany',
                'Amsterdam': 'Netherlands', 'Rotterdam': 'Netherlands', 'The Hague': 'Netherlands',
                'Vienna': 'Austria', 'Salzburg': 'Austria', 'Innsbruck': 'Austria'
            };
            return cityCountryMap[cityName] || 'France'; // Default fallback
        }

        // Experience Marketplace Functions
        async function searchExperiences() {
            const itineraries = getItineraries();
            if (itineraries.length === 0) {
                alert('Please plan a trip first to search for experiences');
                return;
            }

            const cities = [itineraries[0].start_city, ...itineraries[0].intermediate_cities, itineraries[0].end_city];
            const container = document.getElementById('experiences-list');
            let experiencesHtml = '';
            
            for (const city of cities.slice(0, 2)) { // Limit to first 2 cities
                try {
                    const response = await fetch(`/api/enhanced/marketplace/experiences?city=${encodeURIComponent(city.name)}&limit=3`, {
                        credentials: 'same-origin'
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        experiencesHtml += createExperiencesSection(city.name, data.experiences || []);
                    }
                } catch (error) {
                    console.error(`Error loading experiences for ${city.name}:`, error);
                }
            }
            
            container.innerHTML = experiencesHtml || `
                <div class="text-center py-4 text-muted">
                    <i class="fas fa-map-marked-alt fa-2x mb-2"></i>
                    <p>No experiences found. Try searching for a different city.</p>
                </div>
            `;
        }

        function createExperiencesSection(cityName, experiences) {
            if (experiences.length === 0) return '';

            const experiencesHtml = experiences.map(exp => `
                <div class="experience-card">
                    <h6>${exp.title}</h6>
                    <p class="mb-2">${exp.description.substring(0, 100)}...</p>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-primary fw-bold">â‚¬${exp.price}</span>
                        <button class="btn btn-outline-primary btn-sm" onclick="bookExperience(${exp.id})">
                            Book Now
                        </button>
                    </div>
                </div>
            `).join('');

            return `
                <div class="mb-4">
                    <h5><i class="fas fa-map-marker-alt me-2"></i>${cityName}</h5>
                    ${experiencesHtml}
                </div>
            `;
        }

        async function bookExperience(experienceId) {
            try {
                const participants = parseInt(prompt('Number of participants:') || '1');
                const response = await fetch(`/api/enhanced/marketplace/experiences/${experienceId}/book`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        participants: participants,
                        booking_date: new Date().toISOString().split('T')[0]
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        alert('Experience booked successfully!');
                    } else {
                        alert('Error: ' + (result.error || 'Failed to book'));
                    }
                } else {
                    alert('Please log in to book experiences');
                }
            } catch (error) {
                console.error('Error booking experience:', error);
                alert('Error booking experience. Please try again.');
            }
        }

        // AI Optimization Functions
        async function optimizeItinerary() {
            try {
                const response = await fetch(`/api/enhanced/optimization/optimize/${currentTripId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        optimize_for: 'time', // time, cost, or enjoyment
                        energy_pattern: 'moderate',
                        pace_preference: 'relaxed'
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    displayOptimizationResults(result);
                } else {
                    alert('Please log in to optimize your itinerary');
                }
            } catch (error) {
                console.error('Error optimizing itinerary:', error);
                alert('Error optimizing itinerary. Please try again.');
            }
        }

        function displayOptimizationResults(results) {
            const container = document.getElementById('optimization-results');
            
            container.innerHTML = `
                <div class="alert alert-success">
                    <h5><i class="fas fa-check-circle me-2"></i>Optimization Complete!</h5>
                    <p class="mb-0">Your itinerary has been optimized for better time management and cost efficiency.</p>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <h6>Improvements:</h6>
                        <ul>
                            <li>Reduced travel time by 15%</li>
                            <li>Optimized meal times</li>
                            <li>Better activity spacing</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Recommendations:</h6>
                        <ul>
                            <li>Start earlier on Day 2</li>
                            <li>Book dinner reservations</li>
                            <li>Allow buffer time for photos</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        // Additional premium functions for the new UI
        function openJournalModal() {
            if (!isAuthenticated) {
                showAuthRequired();
                return;
            }
            
            createPremiumModal('Travel Journal', `
                <div class="journal-form">
                    <div class="form-group">
                        <label>Entry Title</label>
                        <input type="text" id="journal-title" class="form-control" placeholder="Amazing day in Paris!">
                    </div>
                    <div class="form-group">
                        <label>Your Story</label>
                        <textarea id="journal-content" class="form-control" rows="4" placeholder="Tell us about your adventure..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Entry Type</label>
                        <select id="journal-type" class="form-control">
                            <option value="text">ðŸ“ Text Entry</option>
                            <option value="photo">ðŸ“¸ Photo Story</option>
                            <option value="location">ðŸ“ Location Highlight</option>
                        </select>
                    </div>
                </div>
            `, [
                {
                    text: 'Save Entry',
                    class: 'btn-primary',
                    onclick: 'addJournalFromModal()'
                }
            ]);
        }

        async function addJournalFromModal() {
            const title = document.getElementById('journal-title').value;
            const content = document.getElementById('journal-content').value;
            const type = document.getElementById('journal-type').value;

            if (!title || !content) {
                showToast('Please fill in title and content', 'error');
                return;
            }

            try {
                const btn = event.target;
                btn.classList.add('loading');
                btn.disabled = true;

                const response = await fetch('/api/enhanced/journal/entries', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        trip_id: currentTripId,
                        entry_type: type,
                        title: title,
                        content: content,
                        is_private: false
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        showToast('Journal entry saved!', 'success');
                        loadJournalPreview();
                        document.querySelector('.auth-modal').remove();
                    } else {
                        showToast('Error: ' + (result.error || 'Failed to save entry'), 'error');
                    }
                } else {
                    showToast('Authentication error. Please refresh and try again.', 'error');
                }
            } catch (error) {
                console.error('Error saving journal entry:', error);
                showToast('Error saving entry. Please try again.', 'error');
            } finally {
                const btn = event.target;
                btn.classList.remove('loading');
                btn.disabled = false;
            }
        }

        async function generateSmartPackingList() {
            if (!isAuthenticated) {
                showAuthRequired();
                return;
            }

            const itineraries = getItineraries();
            if (itineraries.length === 0) {
                showToast('Please plan a trip first to generate a packing list', 'error');
                return;
            }

            try {
                const btn = event.target;
                btn.classList.add('loading');
                btn.disabled = true;

                const selectedRoute = itineraries[0];
                const response = await fetch('/api/enhanced/packing/generate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        trip_id: currentTripId,
                        trip_data: {
                            total_duration_hours: selectedRoute.total_duration || 168,
                            route_type: selectedRoute.route_type,
                            weather_data: {
                                average_temperature: 20,
                                precipitation_chance: 30
                            },
                            activities: ['sightseeing', 'cultural']
                        }
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        showToast('Smart packing list generated!', 'success');
                        loadPackingProgressCard();
                    } else {
                        showToast('Error: ' + (result.error || 'Failed to generate list'), 'error');
                    }
                } else {
                    showToast('Authentication error. Please refresh and try again.', 'error');
                }
            } catch (error) {
                console.error('Error generating packing list:', error);
                showToast('Error generating list. Please try again.', 'error');
            } finally {
                const btn = event.target;
                btn.classList.remove('loading');
                btn.disabled = false;
            }
        }

        function showTransportGuide() {
            if (!isAuthenticated) {
                showAuthRequired();
                return;
            }
            
            // Create full-screen transport modal
            createFullScreenModal('Local Transportation Guide', '<div id="transport-guide-content" class="loading">Loading transportation information...</div>');
            
            // Load transport data
            loadFullTransportGuide();
        }

        async function loadFullTransportGuide() {
            const itineraries = getItineraries();
            if (itineraries.length === 0) return;

            const cities = [itineraries[0].start_city, ...itineraries[0].intermediate_cities, itineraries[0].end_city];
            const container = document.getElementById('transport-guide-content');
            
            let content = '<div class="transport-cities">';
            
            for (const city of cities) {
                try {
                    const response = await fetch(`/api/enhanced/transport/city/${encodeURIComponent(city.name)}`, {
                        credentials: 'same-origin'
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        content += createDetailedTransportCard(city.name, data);
                    }
                } catch (error) {
                    console.error(`Error loading transport for ${city.name}:`, error);
                }
            }
            
            content += '</div>';
            container.innerHTML = content;
        }

        function createDetailedTransportCard(cityName, data) {
            return `
                <div class="detailed-transport-card">
                    <h3><i class="fas fa-map-marker-alt me-2"></i>${cityName}</h3>
                    
                    <div class="transport-section">
                        <h4><i class="fas fa-subway me-2"></i>Public Transit</h4>
                        <div class="transport-details">
                            <p><strong>Status:</strong> ${data.public_transit?.available ? 'âœ… Available' : 'âŒ Limited'}</p>
                            <p><strong>Single Ticket:</strong> â‚¬${data.public_transit?.systems?.[0]?.ticket_types?.[0]?.price || 'N/A'}</p>
                            <p><strong>Day Pass:</strong> â‚¬${data.public_transit?.systems?.[0]?.ticket_types?.[1]?.price || 'N/A'}</p>
                        </div>
                    </div>
                    
                    <div class="transport-section">
                        <h4><i class="fas fa-bicycle me-2"></i>Bike Share</h4>
                        <div class="transport-details">
                            <p><strong>Status:</strong> ${data.bike_share?.available ? 'âœ… Available' : 'âŒ Not Available'}</p>
                            ${data.bike_share?.available ? `<p><strong>Price:</strong> â‚¬${data.bike_share?.pricing?.[0]?.price || 'N/A'} per 30min</p>` : ''}
                        </div>
                    </div>
                    
                    <div class="transport-section">
                        <h4><i class="fas fa-car me-2"></i>Parking</h4>
                        <div class="transport-details">
                            <p><strong>Street Parking:</strong> â‚¬${data.parking?.street_parking?.average_price || 'N/A'}/hour</p>
                            <p><strong>Garage Parking:</strong> â‚¬${data.parking?.parking_garages?.[0]?.price_per_day || 'N/A'}/day</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function showEmergencyInfo() {
            createFullScreenModal('Emergency Information', '<div id="emergency-guide-content" class="loading">Loading emergency information...</div>');
            loadFullEmergencyGuide();
        }

        async function loadFullEmergencyGuide() {
            const itineraries = getItineraries();
            if (itineraries.length === 0) return;

            const countries = [...new Set([itineraries[0].start_city, ...itineraries[0].intermediate_cities, itineraries[0].end_city]
                .map(city => getCountryFromCity(city.name)))];
            
            const container = document.getElementById('emergency-guide-content');
            let content = '<div class="emergency-countries">';
            
            for (const country of countries) {
                try {
                    const response = await fetch(`/api/enhanced/emergency/contacts?country=${encodeURIComponent(country)}`, {
                        credentials: 'same-origin'
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        content += createDetailedEmergencyCard(country, data.contacts || []);
                    }
                } catch (error) {
                    console.error(`Error loading emergency info for ${country}:`, error);
                }
            }
            
            content += '</div>';
            container.innerHTML = content;
        }

        function createDetailedEmergencyCard(country, contacts) {
            const contactsHtml = contacts.map(contact => `
                <div class="emergency-contact">
                    <div class="contact-header">
                        <h5>${contact.service_name}</h5>
                        <span class="contact-number">${contact.phone_number}</span>
                    </div>
                    ${contact.address ? `<p class="contact-address">${contact.address}</p>` : ''}
                    ${contact.languages ? `<p class="contact-languages">Languages: ${JSON.parse(contact.languages).join(', ')}</p>` : ''}
                </div>
            `).join('');

            return `
                <div class="detailed-emergency-card">
                    <h3><i class="fas fa-flag me-2"></i>${country}</h3>
                    <div class="emergency-highlight">
                        <div class="emergency-number-big">
                            <span class="number">112</span>
                            <span class="label">EU Emergency Number</span>
                        </div>
                    </div>
                    <div class="emergency-contacts">
                        ${contactsHtml}
                    </div>
                </div>
            `;
        }

        function exploreExperiences() {
            if (!isAuthenticated) {
                showAuthRequired();
                return;
            }
            
            createFullScreenModal('Local Experiences', '<div id="experiences-guide-content" class="loading">Loading local experiences...</div>');
            loadFullExperiencesGuide();
        }

        async function loadFullExperiencesGuide() {
            const itineraries = getItineraries();
            if (itineraries.length === 0) return;

            const cities = [itineraries[0].start_city, ...itineraries[0].intermediate_cities, itineraries[0].end_city];
            const container = document.getElementById('experiences-guide-content');
            let content = '<div class="experiences-cities">';
            
            for (const city of cities.slice(0, 3)) {
                try {
                    const response = await fetch(`/api/enhanced/marketplace/experiences?city=${encodeURIComponent(city.name)}&limit=5`, {
                        credentials: 'same-origin'
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        content += createDetailedExperiencesSection(city.name, data.experiences || []);
                    }
                } catch (error) {
                    console.error(`Error loading experiences for ${city.name}:`, error);
                }
            }
            
            content += '</div>';
            container.innerHTML = content;
        }

        function createDetailedExperiencesSection(cityName, experiences) {
            if (experiences.length === 0) {
                return `
                    <div class="experiences-section">
                        <h3><i class="fas fa-map-marker-alt me-2"></i>${cityName}</h3>
                        <p class="no-experiences">No experiences available for this city yet.</p>
                    </div>
                `;
            }

            const experiencesHtml = experiences.map(exp => `
                <div class="detailed-experience-card">
                    <div class="experience-header">
                        <h5>${exp.title}</h5>
                        <span class="experience-price">â‚¬${exp.price}</span>
                    </div>
                    <p class="experience-description">${exp.description}</p>
                    <div class="experience-meta">
                        <span class="experience-duration">â±ï¸ ${exp.duration_hours || 2}h</span>
                        <span class="experience-participants">ðŸ‘¥ Max ${exp.max_participants || 10}</span>
                        <span class="experience-category">ðŸ·ï¸ ${exp.category}</span>
                    </div>
                    <button class="btn btn-outline-primary btn-sm experience-book-btn" onclick="bookExperienceDetailed(${exp.id}, '${exp.title}', ${exp.price})">
                        Book Experience
                    </button>
                </div>
            `).join('');

            return `
                <div class="experiences-section">
                    <h3><i class="fas fa-map-marker-alt me-2"></i>${cityName}</h3>
                    <div class="experiences-grid">
                        ${experiencesHtml}
                    </div>
                </div>
            `;
        }

        async function bookExperienceDetailed(experienceId, title, price) {
            const participants = prompt(`How many participants for "${title}" (â‚¬${price})?`);
            if (!participants || isNaN(participants)) return;

            try {
                const btn = event.target;
                btn.classList.add('loading');
                btn.disabled = true;

                const response = await fetch(`/api/enhanced/marketplace/experiences/${experienceId}/book`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        participants: parseInt(participants),
                        booking_date: new Date().toISOString().split('T')[0]
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        showToast(`"${title}" booked successfully!`, 'success');
                    } else {
                        showToast('Error: ' + (result.error || 'Failed to book'), 'error');
                    }
                } else {
                    showToast('Authentication error. Please refresh and try again.', 'error');
                }
            } catch (error) {
                console.error('Error booking experience:', error);
                showToast('Error booking experience. Please try again.', 'error');
            } finally {
                const btn = event.target;
                btn.classList.remove('loading');
                btn.disabled = false;
            }
        }

        // Utility Functions
        function createPremiumModal(title, content, buttons = []) {
            const modal = document.createElement('div');
            modal.className = 'auth-modal premium-modal';
            
            const buttonsHtml = buttons.map(btn => 
                `<button class="btn ${btn.class}" onclick="${btn.onclick}">${btn.text}</button>`
            ).join('');
            
            modal.innerHTML = `
                <div class="auth-modal-content premium-modal-content">
                    <div class="auth-modal-header">
                        <h3><i class="fas fa-sparkles me-2"></i>${title}</h3>
                        <button onclick="this.closest('.auth-modal').remove()" class="close-btn">&times;</button>
                    </div>
                    <div class="auth-modal-body">
                        ${content}
                        <div class="modal-actions">
                            ${buttonsHtml}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            return modal;
        }

        function createFullScreenModal(title, content) {
            const modal = document.createElement('div');
            modal.className = 'fullscreen-modal';
            modal.innerHTML = `
                <div class="fullscreen-modal-content">
                    <div class="fullscreen-modal-header">
                        <h2><i class="fas fa-sparkles me-2"></i>${title}</h2>
                        <button onclick="this.closest('.fullscreen-modal').remove()" class="close-btn-large">&times;</button>
                    </div>
                    <div class="fullscreen-modal-body">
                        ${content}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add styles for fullscreen modal
            if (!document.getElementById('fullscreen-modal-styles')) {
                const style = document.createElement('style');
                style.id = 'fullscreen-modal-styles';
                style.textContent = `
                    .fullscreen-modal {
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.95);
                        z-index: 10001;
                        display: flex;
                        flex-direction: column;
                    }
                    .fullscreen-modal-content {
                        width: 100%;
                        height: 100%;
                        background: white;
                        display: flex;
                        flex-direction: column;
                    }
                    .fullscreen-modal-header {
                        background: linear-gradient(135deg, var(--primary), var(--secondary));
                        color: white;
                        padding: 2rem;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    }
                    .fullscreen-modal-body {
                        flex: 1;
                        padding: 2rem;
                        overflow-y: auto;
                    }
                    .close-btn-large {
                        background: none;
                        border: none;
                        color: white;
                        font-size: 2rem;
                        cursor: pointer;
                        padding: 0;
                        width: 40px;
                        height: 40px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        border-radius: 50%;
                        transition: background 0.2s;
                    }
                    .close-btn-large:hover {
                        background: rgba(255,255,255,0.2);
                    }
                `;
                document.head.appendChild(style);
            }
            
            return modal;
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <div class="toast-content">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                    ${message}
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Add toast styles if not already added
            if (!document.getElementById('toast-styles')) {
                const style = document.createElement('style');
                style.id = 'toast-styles';
                style.textContent = `
                    .toast {
                        position: fixed;
                        top: 2rem;
                        right: 2rem;
                        background: white;
                        border-radius: 12px;
                        padding: 1rem 1.5rem;
                        box-shadow: 0 8px 24px rgba(0,0,0,0.15);
                        z-index: 10002;
                        transform: translateX(400px);
                        transition: transform 0.3s ease;
                        border-left: 4px solid var(--primary);
                    }
                    .toast.toast-success { border-left-color: var(--success); }
                    .toast.toast-error { border-left-color: var(--danger); }
                    .toast-content {
                        display: flex;
                        align-items: center;
                        color: var(--gray-800);
                        font-weight: 500;
                    }
                `;
                document.head.appendChild(style);
            }
            
            // Animate in
            setTimeout(() => {
                toast.style.transform = 'translateX(0)';
            }, 100);
            
            // Remove after 3 seconds
            setTimeout(() => {
                toast.style.transform = 'translateX(400px)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        function getCountryFromCity(cityName) {
            const cityCountryMap = {
                'Paris': 'France', 'Lyon': 'France', 'Marseille': 'France', 'Nice': 'France',
                'Rome': 'Italy', 'Milan': 'Italy', 'Venice': 'Italy', 'Florence': 'Italy',
                'Madrid': 'Spain', 'Barcelona': 'Spain', 'Seville': 'Spain', 'Valencia': 'Spain',
                'Berlin': 'Germany', 'Munich': 'Germany', 'Hamburg': 'Germany', 'Cologne': 'Germany',
                'Amsterdam': 'Netherlands', 'Rotterdam': 'Netherlands', 'The Hague': 'Netherlands',
                'Vienna': 'Austria', 'Salzburg': 'Austria', 'Innsbruck': 'Austria'
            };
            return cityCountryMap[cityName] || 'France';
        }

        // Add custom CSS for map icons
        const style = document.createElement('style');
        style.textContent = `
            .custom-div-icon {
                background: transparent !important;
                border: none !important;
                font-size: 16px;
                text-align: center;
                line-height: 20px;
            }
        `;
        document.head.appendChild(style);

        // Mobile optimization: Touch events for better mobile experience
        if ('ontouchstart' in window) {
            // Add touch support for feature cards
            document.querySelectorAll('.feature-card').forEach(card => {
                card.addEventListener('touchstart', function(e) {
                    this.style.transform = 'translateY(-2px)';
                }, {passive: true});
                
                card.addEventListener('touchend', function(e) {
                    setTimeout(() => {
                        this.style.transform = '';
                    }, 150);
                }, {passive: true});
            });

            // Prevent zoom on double tap for buttons
            document.querySelectorAll('.btn, .feature-card').forEach(element => {
                element.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    this.click();
                });
            });
        }

        // Performance: Lazy load images when they come into view
        if ('IntersectionObserver' in window) {
            const imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        img.src = img.dataset.src;
                        img.classList.remove('lazy');
                        imageObserver.unobserve(img);
                    }
                });
            });

            document.querySelectorAll('img[data-src]').forEach(img => {
                imageObserver.observe(img);
            });
        }

        // Performance: Debounced scroll handler for better performance
        let scrollTimer;
        window.addEventListener('scroll', function() {
            if (scrollTimer) clearTimeout(scrollTimer);
            scrollTimer = setTimeout(() => {
                // Handle scroll events here if needed
            }, 16); // ~60fps
        }, {passive: true});
    </script>
</body>
</html>